{% comment %} Base layout â€” do NOT extend anything here {% endcomment %}
{% load static %}
<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Micro-SOP Generator{% endblock %}</title>

    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
    <link rel="icon" href="{% static 'favicon.ico' %}" />

    <!-- HTMX (+ optional helpers) -->
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
    <script src="https://unpkg.com/hyperscript.org@0.9.12" defer></script>
  </head>

  <body class="bg-gray-950 text-white antialiased">
    <main class="min-h-screen px-6 py-10">
      {% block content %}{% endblock %}
    </main>

    <!-- ========= Global Modal (single overlay, safe clicks) ========= -->
    <style>
      /* When hidden, make sure the overlay never eats clicks */
      #modal.hidden { pointer-events: none !important; }
    </style>

    <div id="modal" class="fixed inset-0 z-50 hidden pointer-events-none">
      <!-- Backdrop (click closes) -->
      <div id="modal-backdrop"
           class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-150"
           onclick="closeModal()"></div>

      <!-- Body target (HTMX swaps into here) -->
      <div id="modal-content"
           class="relative z-10 w-full max-w-md mx-auto translate-y-2 opacity-0 transition duration-150">
      </div>
    </div>

    <script>
      function getCSRFCookie(){
          const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
          return m ? decodeURIComponent(m[1]) : "";
        }

        document.body.addEventListener('htmx:configRequest', (evt) => {
          evt.detail.headers['X-CSRFToken'] = getCSRFCookie();
        });

        // optional: debug what we send
        document.body.addEventListener('htmx:configRequest', (evt) => {
          console.log('X-CSRFToken ->', evt.detail.headers['X-CSRFToken']);
        });

      // Always attach a valid CSRF header to HTMX requests.
      // Prefer cookie; if missing, fall back to the nearest form's hidden field.
      document.body.addEventListener('htmx:configRequest', (e) => {
        let token = getCookie('csrftoken');
        if (!token) {
          const form = e.target.closest && e.target.closest('form');
          const inp  = form && form.querySelector('input[name="csrfmiddlewaretoken"]');
          if (inp) token = inp.value;
        }
        if (token) e.detail.headers['X-CSRFToken'] = token;
      });

      // --- Modal helpers ---
      function showModal(){
        const modal    = document.getElementById('modal');
        const backdrop = document.getElementById('modal-backdrop');
        const content  = document.getElementById('modal-content');
        if (!modal || !backdrop || !content) return;

        // make interactive & visible
        modal.classList.remove('hidden','pointer-events-none');
        backdrop.style.opacity = '1';
        content.style.opacity  = '1';
        content.style.transform = 'translateY(0)';
        document.body.classList.add('overflow-hidden');
      }

      function closeModal(){
        const modal    = document.getElementById('modal');
        const backdrop = document.getElementById('modal-backdrop');
        const content  = document.getElementById('modal-content');
        if (!modal || !backdrop || !content) return;

        // clear the body so next open starts fresh
        content.innerHTML = '';

        // instantly non-interactive
        modal.classList.add('hidden','pointer-events-none');

        // reset visuals for next open
        backdrop.style.opacity = '0';
        content.style.opacity  = '0';
        content.style.transform = 'translateY(0.5rem)';

        document.body.classList.remove('overflow-hidden');
      }
      window.closeModal = closeModal;

      // Ensure the target exists before HTMX swaps (in case a partial removed it)
      document.body.addEventListener('htmx:beforeRequest', (e) => {
        const tgt = e.target?.getAttribute?.('hx-target') || '';
        if (tgt === '#modal-content' && !document.getElementById('modal-content')) {
          const modal = document.getElementById('modal');
          if (modal) {
            modal.innerHTML = `
              <div id="modal-backdrop"
                   class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-150"
                   onclick="closeModal()"></div>
              <div id="modal-content"
                   class="relative z-10 w-full max-w-md mx-auto translate-y-2 opacity-0 transition duration-150">
              </div>
            `;
          }
        }
      });

      // Auto-show when HTMX swaps into #modal-content
      document.body.addEventListener('htmx:afterSwap', (e) => {
        if (e.detail?.target?.id === 'modal-content') showModal();
      });

      // ESC to close
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
    </script>
  </body>
</html>
