{% load i18n %}

<div class="bg-gray-900 text-white rounded-2xl shadow-xl max-w-2xl w-full p-8 relative">
  <h2 class="text-2xl font-bold mb-4 text-center">
    {% trans "Generate a Micro-SOP" %}
  </h2>

  {% if errors.non_field %}
    <div class="mb-4 rounded-lg bg-red-600/10 border border-red-500 px-3 py-2 text-sm text-red-200">
      {{ errors.non_field }}
    </div>
  {% endif %}

  <!-- CSRF header helper used by htmx -->
  <script>
    window.csrfHeaders = function () {
      const m = document.cookie.match(/(?:^| )csrftoken=([^;]+)/);
      if (m) return { "X-CSRFToken": decodeURIComponent(m[1]) };
      const f = document.getElementById('generate-form');
      return { "X-CSRFToken": inp ? inp.value : "" };
    };
  </script>

  <form id="generate-form"
        hx-post="{% url 'api-generate-sop' %}"
        hx-target="#result-box"
        hx-swap="outerHTML"
        class="space-y-4">

    <!-- Niche -->
    <div>
      <label class="block text-sm mb-1 font-medium">{% trans "Niche" %}</label>
      <select name="niche"
              class="w-full bg-gray-800 border border-gray-700 focus:border-gray-500 focus:outline-none rounded-lg px-4 py-2">
        <option value="general">{% trans "General" %}</option>
        <option value="freelance">{% trans "Freelance / Services" %}</option>
        <option value="consulting">{% trans "Consulting" %}</option>
        <option value="events">{% trans "Events" %}</option>
        <option value="coaching">{% trans "Coaching" %}</option>
        <option value="design">{% trans "Design" %}</option>
      </select>
    </div>

    <!-- Tone -->
    <div>
      <label class="block text-sm mb-1 font-medium">{% trans "Tone" %}</label>
      <select name="tone"
              class="w-full bg-gray-800 border border-gray-700 focus:border-gray-500 focus:outline-none rounded-lg px-4 py-2">
        <option value="professional">{% trans "Professional" %}</option>
        <option value="friendly">{% trans "Friendly" %}</option>
        <option value="direct">{% trans "Direct" %}</option>
      </select>
    </div>

    <!-- Prompt -->
    <div>
      <label class="block text-sm mb-1 font-medium">{% trans "What do you need?" %}</label>
      <textarea name="prompt" rows="5" required
                class="w-full bg-gray-800 border border-gray-700 focus:border-gray-500 focus:outline-none rounded-lg px-4 py-2 resize-y"
                placeholder="{% trans 'Ex: client late on payment — polite reminder with deadline and payment line. If you want a checklist, say it here.' %}">{{ form_data.prompt|default_if_none:'' }}</textarea>
      {% if errors.prompt %}<div class="text-red-300 text-sm mt-1">{{ errors.prompt }}</div>{% endif %}
    </div>

    <!-- Payment -->
    <div>
      <label class="block text-sm mb-1 font-medium">{% trans "Payment method" %}</label>
      <select name="payment_method" id="payment-method"
              class="w-full bg-gray-800 border border-gray-700 focus:border-gray-500 focus:outline-none rounded-lg px-4 py-2"
              onchange="window.togglePayValue(this.value)">
        <option value="none">{% trans "No payment" %}</option>
        <option value="mbway">MB Way</option>
        <option value="iban">IBAN / NIB</option>
        <option value="stripe">Stripe Link</option>
      </select>
    </div>

    <div id="pay-value-wrap" class="hidden">
      <label id="pay-value-label" class="block text-sm mb-1 font-medium"></label>
      <input name="payment_value" id="pay-value-input"
             class="w-full bg-gray-800 border border-gray-700 focus:border-gray-500 focus:outline-none rounded-lg px-4 py-2"
             placeholder="">
      {% if errors.payment_value %}<div class="text-red-300 text-sm mt-1">{{ errors.payment_value }}</div>{% endif %}
    </div>

    <!-- Add to calendar -->
    <label class="inline-flex items-center gap-2 text-sm text-gray-300">
      <input type="checkbox" name="add_to_calendar" id="add-to-calendar"
             class="h-4 w-4 rounded border-gray-600 bg-gray-800">
      <span>{% trans "Add to calendar if an explicit date/time is detected" %}</span>
    </label>

    <div class="flex items-center gap-3">
      <button type="submit"
              class="bg-purple-600 hover:bg-purple-700 py-2 rounded-xl font-medium px-4">
        {% trans "Generate" %}
      </button>
    </div>
  </form>

  <!-- Result target -->
  <div id="result-box" class="mt-5">
    <div class="text-gray-400 text-sm">{% trans "The result will appear here." %}</div>
  </div>

  <!-- Close button -->
  <button onclick="window.closeModal()"
          class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl"
          aria-label="{% trans 'Close' %}">×</button>
</div>

<script>
  // Wrap everything to avoid redeclarations when modal is reopened
  (function () {
    const PAY_KEYS = { mbway:'sop_pay_mbway', iban:'sop_pay_iban', stripe:'sop_pay_stripe' };

    window.togglePayValue = function (method) {
      const wrap  = document.getElementById('pay-value-wrap');
      const label = document.getElementById('pay-value-label');
      const input = document.getElementById('pay-value-input');
      if (!wrap || !label || !input) return;

      if (method === 'mbway') {
        wrap.classList.remove('hidden');
        label.textContent = 'MB Way phone number';
        input.placeholder = '9XXXXXXXX';
        input.value = localStorage.getItem(PAY_KEYS.mbway) || input.value || '';
      } else if (method === 'iban') {
        wrap.classList.remove('hidden');
        label.textContent = 'IBAN / NIB';
        input.placeholder = 'PT50 …';
        input.value = localStorage.getItem(PAY_KEYS.iban) || input.value || '';
      } else if (method === 'stripe') {
        wrap.classList.remove('hidden');
        label.textContent = 'Stripe Payment Link';
        input.placeholder = 'https://buy.stripe.com/...';
        input.value = localStorage.getItem(PAY_KEYS.stripe) || input.value || '';
      } else {
        wrap.classList.add('hidden');
        label.textContent = '';
        input.value = '';
      }
    };

    (function persistForm(){
      const form     = document.getElementById('generate-form');
      const methodEl = document.getElementById('payment-method');
      const payInput = document.getElementById('pay-value-input');
      const addCal   = document.getElementById('add-to-calendar');

      try {
        const saved = JSON.parse(localStorage.getItem('sopForm') || '{}');
        for (const [k,v] of Object.entries(saved)) {
          const el = form.querySelector(`[name="${k}"]`);
          if (!el) continue;
          if (el.type === 'checkbox') el.checked = !!v;
          else el.value = v;
        }
      } catch {}

      window.togglePayValue(methodEl.value || 'none');

      form.addEventListener('input', () => {
        const method = methodEl.value;
        if (['mbway','iban','stripe'].includes(method)) {
          localStorage.setItem(PAY_KEYS[method], payInput.value || '');
        }
        const data = Object.fromEntries(new FormData(form).entries());
        data.add_to_calendar = addCal.checked;
        localStorage.setItem('sopForm', JSON.stringify(data));
      });

      methodEl.addEventListener('change', () => {
        const prev = Object.keys(PAY_KEYS).find(k => k !== methodEl.value);
        if (prev && ['mbway','iban','stripe'].includes(prev) && payInput) {
          localStorage.setItem(PAY_KEYS[prev], payInput.value || '');
        }
        window.togglePayValue(methodEl.value);
      });
    })();
  })();
</script>
