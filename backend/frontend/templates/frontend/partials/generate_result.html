{% load i18n %}
<div id="result-box" class="bg-gray-800 text-white rounded-xl p-4 space-y-4">
  {% if error %}
    <div class="rounded-lg bg-red-600/10 border border-red-500 px-3 py-2 text-sm text-red-200">
      {{ error }}
    </div>

    {# Optional technical details (only shown if the view sets error_detail in DEBUG) #}
    {% if error_detail %}
      <details class="rounded-lg bg-black/30 border border-red-500/40 px-3 py-2 text-xs text-red-200/90">
        <summary class="cursor-pointer select-none">{% trans "Technical details (dev)" %}</summary>
        <pre class="mt-2 whitespace-pre-wrap">{{ error_detail }}</pre>
      </details>
    {% endif %}

    <div class="flex items-center gap-3">
      {# Retry: re-submits the original generator form via HTMX without touching the modal body #}
      <button
        type="button"
        class="bg-white/10 hover:bg-white/20 text-sm px-3 py-1 rounded"
        onclick="retryGenerate(this)"
      >
        {% trans "Try again" %}
      </button>
      <span class="text-xs text-gray-400">{% trans "If this keeps happening, please report it." %}</span>
    </div>

    <script>
      // Minimal, safe retry helper. No route names, no template vars inside JS.
      function retryGenerate(btn){
        var form = document.querySelector('form#generate-form') ||
                   document.querySelector('form[hx-target="#result-box"]');
        if(!form){ console.warn('Generator form not found'); return; }

        var url = form.getAttribute('hx-post') || form.getAttribute('action') || window.location.href;

        var old = btn.textContent;
        btn.disabled = true;
        btn.textContent = '{{ _("Workingâ€¦") }}';

        htmx.ajax('POST', url, {
          target: '#result-box',
          swap: 'outerHTML',
          source: form,
          headers: {'X-CSRFToken': (typeof getCookie==='function' ? getCookie('csrftoken') : '')}
        }).finally(function(){
          btn.disabled = false;
          btn.textContent = old;
        });
      }
    </script>

  {% else %}
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold">{% trans "Result" %}</h3>
      <button
        id="copy-btn"
        type="button"
        class="bg-white/10 hover:bg-white/20 text-sm px-3 py-1 rounded"
        data-copy="{% trans 'Copy' %}"
        data-copied="{% trans 'Copied!' %}"
        onclick="(function(b){
          const t = document.getElementById('sop-plain')?.textContent || '';
          navigator.clipboard.writeText(t).then(() => {
            b.textContent = b.dataset.copied;
            setTimeout(() => { b.textContent = b.dataset.copy; }, 1200);
          });
        })(this)"
      >
        {% trans "Copy" %}
      </button>
    </div>

    <pre id="sop-plain" class="whitespace-pre-wrap break-words text-sm leading-relaxed">{{ plain_text }}</pre>

    {% if calendar_suggestion %}
      <div class="border-t border-white/10 pt-3">
        <h4 class="font-semibold mb-2">{% trans "Add to calendar" %}</h4>

        <form
          hx-post="{% url 'calendar-add' %}"
          hx-target="#calendar-feedback"
          hx-swap="innerHTML"
          hx-headers='js:{"X-CSRFToken": getCookie("csrftoken")}'
          class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"
        >
          {% csrf_token %}

          <input type="text" name="title"
                 class="bg-gray-900 border border-gray-700 rounded px-3 py-2"
                 placeholder="{% trans 'Title' %}"
                 value="{{ calendar_suggestion.title|default_if_none:'' }}">

          <input type="text" name="location"
                 class="bg-gray-900 border border-gray-700 rounded px-3 py-2"
                 placeholder="{% trans 'Location' %}"
                 value="{{ calendar_suggestion.location|default_if_none:'' }}">

          <input type="date" name="date"
                 class="bg-gray-900 border border-gray-700 rounded px-3 py-2"
                 value="{{ calendar_suggestion.date|default_if_none:'' }}">

          <div class="flex gap-2">
            <input type="time" name="start_time"
                   class="bg-gray-900 border border-gray-700 rounded px-3 py-2 w-full"
                   value="{{ calendar_suggestion.start_time|default_if_none:'' }}">
            <input type="time" name="end_time"
                   class="bg-gray-900 border border-gray-700 rounded px-3 py-2 w-full"
                   value="{{ calendar_suggestion.end_time|default_if_none:'' }}">
          </div>

          <div class="md:col-span-2">
            <textarea name="description" rows="2"
                      class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2"
                      placeholder="{% trans 'Notes' %}">{{ calendar_suggestion.description|default_if_none:'' }}</textarea>
          </div>

          <div class="md:col-span-2 flex items-center gap-3">
            <button type="submit" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">
              {% trans "Add event" %}
            </button>
            <div id="calendar-feedback" class="text-xs text-gray-300"></div>
          </div>
        </form>
      </div>
    {% endif %}
  {% endif %}
</div>
